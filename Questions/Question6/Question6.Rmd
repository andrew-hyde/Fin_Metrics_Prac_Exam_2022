---
title: 'Question 6: MSCI Funds'
author: "Andrew Hyde"
date: '2022-11-26'
output:
  pdf_document: default
  html_document: default
---


```{r setup}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.width = 6, fig.height = 5, fig.pos="H", fig.pos = 'H')
# Note: Include = FALSE implies the code is executed, but not printed in your pdf.
# warning and message = FALSE implies ugly messages and warnings are removed from your pdf.
# These should be picked up when you execute the command chunks (code sections below) in your rmd, not printed in your paper!


# load packages
pacman::p_load("MTS", "robustbase")
pacman::p_load("tidyverse", "devtools", "rugarch", "rmgarch", 
    "forecast", "tbl2xts", "lubridate", "PerformanceAnalytics", 
    "ggthemes", "ks")
pacman::p_load("tidyverse", "rugarch", "rmgarch")


# load functions
list.files('code/', full.names = T, recursive = T) %>% .[grepl('.R', .)] %>% as.list() %>% walk(~source(.))


# oad data, and see how this can be stored and later called from your 'data' folder.
msci <- read_rds("data/msci.rds")
bonds <- read_rds("data/bonds_10y.rds")
comms <- read_rds("data/comms.rds")

```

# Introduction \label{Introduction}

Using the MSCI total return indexes, write a short report where you discuss the following (please
use your discretion on which returns you want to use to make your argument):

Over the past decade, the return profiles of different asset classes (Equities, Commodities,
Real Estate and Bonds) have increased in their convergence (i.e., diversification by holding
different asset classes have reduced).

Show how these co-movements have increased in the past decade;

Show to what extent these return profiles have homogenized by considering the commonality of the sources of returns over time.

In your answer, be creative in using visual and statistical measures to convey the issue of
how co-movement have changed over time

# Data
I begin by selecting specific assets from the data sets provided and follow an approach similar to the practical. I select the MSCI_ACWI index to represent Equities, the BCom_Index to represent Commodities, the MSCI_RE to represent Real Estate and the US_10Yr to represent bonds. I calculate returns for the daily price data before combining the data to perform the analysis, followed by log scaling and centering the data. This was tricky to accomplish in one go so I split it up into its parts, wrangled the data and then combined the data.

```{r message=FALSE, warning=FALSE}
# view that names of the different asset classes
#msci %>% pull(Name) %>% unique
#bonds %>% pull(Name) %>% unique
#comms %>% pull(Name) %>% unique

# wrap in a function to neaten it up
q6_data_cleaning_func <- function(df_data){

# struggling to get results inside of 'left_join'
# do it individually
msci <- msci %>% mutate(Return = log(Price) - log(lag(Price))) %>% select(-Price)
comms <- comms %>% mutate(Return = log(Price) - log(lag(Price))) %>% select(-Price)
bonds <- bonds %>% mutate(Return = log(Bond_10Yr) - log(lag(Bond_10Yr))) %>% select(-Bond_10Yr)

# this works if calc individually firms
q6_data_combined <- left_join(msci %>% 
                        spread(Name, Return) %>%
                        select(date, MSCI_ACWI, MSCI_RE),
                    
                        bonds %>% spread(Name, Return) %>% select(date, US_10Yr),
                                by = "date") %>% 
    
                    left_join(.,
                            comms %>% spread(Name, Return) %>% select(date, Bcom_Index),
                                by = "date" )

# this works if calc individually firms
library(lubridate)
q6_data_combined_use <- 
    q6_data_combined %>% 
    gather(Asset, Return, -date) %>% 
    arrange(date) %>% 
    group_by(Asset) %>% 
    mutate(scaled_ret = Return - mean(Return, na.rm = T)) %>% 
    # filter(Name %in% c("MSCI_ACWI", "MSCI_RE", "MSCI_USA", "MSCI_USREIT")) %>% 
    filter(date >= as.Date("2012-01-01") & date <= as.Date("2022-12-31")) %>% 
    filter(date > dplyr::first(date)) %>% 
    select(-Return)


library(tbl2xts)
library(rugarch)
xts_q6_data_combined <- 
    q6_data_combined_use %>% tbl2xts::tbl_xts(., cols_to_xts = "scaled_ret", spread_by = "Asset")

#MTS::MarchTest(xts_q5_data_combined)

xts_q6_data_combined

}

xts_q6_data_combined_use <- q6_data_cleaning_func(df_data)

```

# DCC Model
I follow the practical code closely to render the model

```{r message=FALSE, warning=FALSE}

# use dccPre to fit the univariate GARCH models to each series in the data frame of returns.
# Let's select a VAR order of zero for the mean equation, and use the mean of each series.

# Then, for every series, a standard univariate GARCH(1,1) is run - giving us:
# et and sigmat, which is then used to calculate the standardized resids, zt.
# zt is used in DCC calcs after.


# wrap in a function to neaten it up
q6_mv_garch_func <- function(df_data){
    
    DCCPre <- dccPre(xts_q6_data_combined_use, include.mean = T, p = 0)

    # estimates of volatility for each series.
    Vol <- DCCPre$marVol
    colnames(Vol) <- colnames(xts_q6_data_combined_use)
    
    Vol <- data.frame(cbind(date = index(xts_q6_data_combined_use), Vol)) %>% 
        # Add date column 
                mutate(date = as.Date(date)) %>%  tbl_df()
    
    
    # volatility
    Vol

}

Vol <- q6_mv_garch_func(df_data)


```


```{r}

# use 'Vol' in the volatility plot
ggplot(Vol %>% gather(Asset, Sigma, -date)) + 
    geom_line(aes(x = date, y = Sigma, colour = Asset)) + 
    
            labs(title = "Volatility of Returns for the past decade",
             subtitle = "Different Asset Classes",
             caption = "Commodities, Equities, Real Estate and Bonds",
             x = "",
             y = "Sigma") +
    
         fmxdat::theme_fmx(legend.pos = "bottom")

```





```{r message=FALSE, warning=FALSE}


FUNC <- function(df_data){

DCCPre <- dccPre(xts_q6_data_combined_use, include.mean = T, p = 0)
# After saving now the standardized residuals:
StdRes <- DCCPre$sresi

# We can now use these sresids to calculate the DCC model.

# In order to fit the DCC model detach the tidyr and dplyr packages, 
# once detached can now run dccFit
# when done then tidyr and dplyr 


detach("package:tidyverse", unload=TRUE)
detach("package:tbl2xts", unload=TRUE)

DCC <- dccFit(StdRes, type="Engle")


DCC

}

DCC <- FUNC(df_data)

pacman::p_load("tidyverse", "rmsfuns", "fmxdat", "tbl2xts", "broom")



```


Now the DCC model has been estimated.

To produce the Dynamic Conditional Correlations graphs for the four asset classes I nest the renaming function from the practicals inside of a graphing function, so that it can be reused simply by changing the input names.

```{r}

graph_rename_func_q6(input_name_1 = "US_10Yr_",
                     input_name_2 = "_US_10Yr",
                     title = "Dynamic Conditional Correlations: US_10Yr",
                     subtitle = "",
                     caption = "Commodities, Equities, Real Estate and Bonds",
                     xlabel = "",
                     ylabel = "Rho")

```


```{r}
# make use of the graph func with the renaming func nested within it.


graph_rename_func_q6(input_name_1 = "Bcom_Index_",
                     input_name_2 = "_Bcom_Index",
                     title = "Dynamic Conditional Correlations: Bcom_Index",
                     subtitle = "Plot of Total Cases and Deaths per Continent",
                     caption = "Commodities, Equities, Real Estate and Bonds",
                     xlabel = "",
                     ylabel = "Rho")

```



```{r}

graph_rename_func_q6(input_name_1 = "MSCI_ACWI_",
                     input_name_2 = "_MSCI_ACWI",
                     title = "Dynamic Conditional Correlations: MSCI_ACWI",
                     subtitle = "",
                     caption = "Commodities, Equities, Real Estate and Bonds",
                     xlabel = "",
                     ylabel = "Rho")

```



```{r}

graph_rename_func_q6(input_name_1 = "MSCI_RE_",
                     input_name_2 = "_MSCI_RE",
                     title = "Dynamic Conditional Correlations: MSCI_RE",
                     subtitle = "",
                     caption = "Commodities, Equities, Real Estate and Bonds",
                     xlabel = "",
                     ylabel = "Rho")

```






